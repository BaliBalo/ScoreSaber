!async function(){document.body.classList.add("js-loaded");const e={GN:.04,DA:.02,FS:.08,NF:-.5,NO:-.05,NB:-.1,SS:-.3,NA:-.3},t=[{at:0,value:0},{at:45,value:.015},{at:50,value:.03},{at:55,value:.06},{at:60,value:.105},{at:65,value:.16},{at:68,value:.24},{at:70,value:.285},{at:80,value:.563},{at:84,value:.695},{at:88,value:.826},{at:94.5,value:1.015},{at:95,value:1.046},{at:100,value:1.12},{at:110,value:1.18},{at:114,value:1.25}],n={ExpertPlus:{className:"expert-plus",display:"Expert+"}};function i(e,t){e&&(e.classList.remove(t),e.offsetWidth,e.classList.add(t))}function a(e,t=0){return e.toFixed(t).replace(/\.?0*$/,"")}function r(e,t,n){return e<t?t:e>n?n:e}function s(e,t,n){return t+e*(n-t)}function l(e,t,n){return r((e-t)/(n-t),0,1)}function o(e){return("0"+e).slice(-2)}function c(e,t){let n=e.getFullYear()+"-"+o(e.getMonth()+1)+"-"+o(e.getDate()),i=o(e.getHours())+":"+o(e.getMinutes());return t&&(i+=":"+o(e.getSeconds())),n+" "+i}const d=function(){const e=864e5;let t=(e,t)=>~~(e/t),n=(e,t)=>e+" "+t+(1!==e&&-1!==e?"s":"");return i=>function(i,a){let r=a-i,s=Math.abs(r);if(s<6e4)return n(t(r,1e3),"second");if(s<36e5)return n(t(r,6e4),"minute");if(s<e)return n(t(r,36e5),"hour");if(s<2592e6)return n(t(r,e),"day");let l=function(e,t){let n=t.getFullYear()-e.getFullYear();return t.getMonth()-e.getMonth()+12*n}(i,a);return Math.abs(l)<12?n(l,"month"):n(~~(l/12),"year")}(i,new Date)+" ago"}();function u(e,t,n,i){let a=document.createElement(e);return null!=t&&(a.className=t),null!=n&&a.append(...Array.isArray(n)?n:[n]),null!=i&&(a.title=i),a}let p=u.bind(null,"div"),h=u.bind(null,"span"),m=(e,t,n)=>{let i=u("input",e);return t&&(i.value=t),n&&(i.placeholder=n),i},f=(e,t)=>{let n=u("option");return n.textContent=e,n.value=t,n},g=(e,t,n,i,a)=>{let r=u("a",t,n,i);return r.href=e,a&&(r.target=a),r};function y(e,t){let n=g(e);n.download=t,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function v(e){await new Promise(t=>setTimeout(t,e))}async function b(...e){return fetch(...e).then(e=>e.ok?e.text():Promise.reject()).then(e=>{if(-1===e.indexOf("<html"))throw new Error("not an HTML page: "+e);return(new DOMParser).parseFromString(e,"text/html")})}async function C(e,t,n=1,i=2){return b("/proxy/u/"+e+"?sort="+n+"&page="+(t||1)).catch(async a=>{if(i-- >0)return await v(1e3),C(e,t,n,i);throw a})}function k(e){let t;return e&&(t={headers:{"If-Modified-Since":e.toUTCString()}}),function(...e){return fetch(...e).then(e=>e.json())}("/ranked",t).then(e=>(function(e){J=e.timestamp;let t=new Date(J);ae.textContent=d(t)+" ("+c(t,!0)+")",ae.title=t.toString(),ae.classList.remove("unknown")}(e),e))}function S(t){return t?t.split(",").reduce((t,n)=>t+(e[n.trim()]||0),1):1}function w(e,t){if(!t.length||"number"!=typeof e||Number.isNaN(e))return 0;let n=t.findIndex(t=>t.at>=e);if(-1===n)return t[t.length-1].value;if(!n)return t[0].value;let i=t[n-1],a=t[n],r=(e-i.at)/(a.at-i.at);return i.value+(a.value-i.value)*r}function x(e){if(!e)return null;let t=e.getAttribute("src");return t.match(/^https?:\/\//)||(t="https://scoresaber.com"+("/"===t[0]?"":"/")+t),t}WebFont.load({custom:{families:["NeonTubes"]}});let E=document.getElementById("user"),L=document.getElementById("profile"),I=document.getElementById("user-fetch-info"),P=[];try{let e=JSON.parse(localStorage.getItem("history"));Array.isArray(e)&&(P=e)}catch(e){}let T=document.querySelector(".history");function M(){T.innerHTML="",P.slice(0,5).forEach(e=>{if(!e||!e.avatar||null==e.rank||!e.name)return;let t=p("line");t.onclick=()=>{L.disabled||(L.value=e.id,ye())};let n=p("avatar");n.style.backgroundImage="url("+e.avatar+")",t.appendChild(n),t.appendChild(p("rank",e.rank.toLocaleString())),t.appendChild(p("name",e.name)),T.appendChild(t)})}function O(e){P=P.filter(t=>t&&t.id!==e.id),P.unshift(e),P=P.slice(0,5);try{localStorage.setItem("history",JSON.stringify(P))}catch(e){}M()}M();let N={};async function D(e){N=e;try{let t=JSON.stringify(e,(e,t)=>Math.abs(t)===1/0?t+"":t);localStorage.setItem("peepee-filters",t)}catch(e){}ge.refresh(),fe.refresh()}function q(e){let t=h(),n=getComputedStyle(e);Object.assign(t.style,{position:"absolute",top:"-99px",left:"-99px",height:"0",whiteSpace:"pre",overflow:"hidden",visibility:"hidden",font:n.font,letterSpacing:n.letterSpacing,padding:n.padding});let i=()=>{t.textContent=e.value||" ",e.style.width=t.clientWidth+1+"px"};return document.body.appendChild(t),e.addEventListener("input",i),i(),{check:i,stop:()=>document.body.removeChild(t)}}async function A(e={}){let t,n;(e=Object.assign({},e)).hiddenMaps&&(e.hiddenMaps=e.hiddenMaps.slice());let i=new Promise((e,i)=>{t=e,n=i}),a=[],r=!1,s=e=>{r||(r=!0,a.forEach(e=>e.stop()),document.body.removeChild(l)),t(e)},l=p("filters-modal"),o=p("content"),c=u("h2",null,"FILTERS"),d=p("buttons"),h=u("button","cancel","Cancel"),g=u("button","ok","OK"),y=p("scroller"),v=m(null,e.scoreFrom),b=m(null,e.scoreTo),C=p("filter score",["Only show maps if the potential score is between ",v,"% and ",b,"%"]),k=m(null,e.starsFrom),S=m(null,e.starsTo),w=p("filter stars",["Only show maps if their ★ difficulty is between ",k," and ",S]),x=u("select");x.size=6,x.multiple=!0,(e.hiddenMaps||[]).forEach(e=>{let t=K[e];if(!t)return;let n=t.name+" - "+t.artist+" ("+t.mapper+") | "+t.diff;x.append(f(n,e))});let E=u("button",null,"Unhide selected");E.disabled=!0;let L=p("filter hidden-maps",["Hide these specific maps (right click on a map to add it to this list):",x,E]),I=()=>{v.value=+v.value||0,b.value=!b.value||isNaN(+b.value)?"Infinity":+b.value,k.value=+k.value||0,S.value=!S.value||isNaN(+S.value)?"Infinity":+S.value,a.forEach(e=>e.check())};return[v,b,k,S].forEach(e=>e.addEventListener("change",I)),I(),a.push(...[v,b,k,S].map(q)),x.addEventListener("change",()=>{E.disabled=!x.selectedOptions.length}),E.addEventListener("click",()=>{let e=x.selectedIndex;[...x.selectedOptions].forEach(e=>x.removeChild(e)),x.selectedIndex=Math.min(e,x.length-1)}),g.addEventListener("click",()=>{I(),s({scoreFrom:+v.value,scoreTo:+b.value,starsFrom:+k.value,starsTo:+S.value,hiddenMaps:[...x.options].map(e=>+e.value)})}),h.addEventListener("click",()=>s(null)),l.addEventListener("click",e=>{o.contains(e.target)||s(null)}),y.append(C,w,L),d.append(h,g),o.append(c,y,d),l.append(o),document.body.append(l),i}!function(){N={scoreFrom:0,scoreTo:1/0,starsFrom:0,starsTo:1/0,hiddenMaps:[]};try{let e=JSON.parse(localStorage.getItem("peepee-filters"),(e,t)=>"Infinity"===t||"-Infinity"===t?+t:t);Object.assign(N,e),N.scoreFrom=+N.scoreFrom||0,N.scoreTo=isNaN(+N.scoreTo)?1/0:+N.scoreTo,N.starsFrom=+N.starsFrom||0,N.starsTo=isNaN(+N.starsTo)?1/0:+N.starsTo,Array.isArray(N.hiddenMaps)||(N.hiddenMaps=[])}catch(e){}}();let F=[];async function B(e=[]){let t,n;e=JSON.parse(JSON.stringify(e));let i=new Promise((e,i)=>{t=e,n=i}),r=!1,o=e=>{r||(r=!0,window.removeEventListener("resize",N),document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",O),document.body.removeChild(c)),t(e)},c=p("custom-curve-modal"),d=p("content"),m=u("h2",null,"CUSTOM CURVE EDITOR"),f=p("buttons"),g=u("button","cancel","Cancel"),y=u("button","ok","OK"),v=p("scroller"),b=p("instructions","Left click to add or move points, right click to remove points"),C=p("editor"),k=u("canvas","preview"),S=k.getContext("2d"),w=p("points"),x=null,E=!1,L=e=>({x:s(e.at/15,34,k.width),y:s(e.value/1.12,k.height-20,0)}),I=e=>({at:15*l(e.x,34,k.width),value:1.12*l(e.y,k.height-20,0)}),P=()=>{if(ie(S,{numPoints:0,marginX:34,marginY:20,maxPercentage:1.12,maxStars:15,playerSongsColor:"rgbs(136, 238, 255, .7)"}),e.length){S.strokeStyle="rgba(250, 120, 20, 1)",S.lineWidth=2,S.beginPath();let t=L({at:0,value:e[0].value});S.moveTo(t.x,t.y),e.forEach(e=>{let t=L(e);S.lineTo(t.x,t.y)});let n=L({at:15,value:e[e.length-1].value});S.lineTo(n.x,n.y),S.stroke(),S.fillStyle="rgba(20, 250, 120, 1)",S.strokeStyle="rgba(20, 250, 120, 1)",e.forEach(e=>{let t=L(e);S.fillRect(t.x-3,t.y-3,6,6),e===x&&(S.beginPath(),S.arc(t.x,t.y,8,0,2*Math.PI),S.stroke())}),S.lineWidth=1}},T=()=>{e.sort((e,t)=>e.at-t.at),w.innerHTML="",e.forEach(e=>{let t=p("point"),n=p("at",[h("label","At: "),h("value",a(e.at,2)+"★")]),i=p("score",[h("label","Score: "),h("value",a(100*e.value,2)+"%")]);t.append(n,i),w.append(t)})},M=t=>{if(!e.length)return;let n=k.getBoundingClientRect(),i=t.clientX-n.left,a=t.clientY-n.top;if(E){t.preventDefault();let e=I({x:i,y:a});return Object.assign(x,e),T(),void P()}let r=e.map(e=>{let t=L(e),n=i-t.x,r=a-t.y;return{point:e,d:n*n+r*r}});r.sort((e,t)=>e.d-t.d);let s=r[0].d<81?r[0].point:null;x!==s&&(x=s,P())};document.addEventListener("mousemove",M),k.addEventListener("mousedown",t=>{if(t.preventDefault(),2===t.button)return e=e.filter(e=>e!==x),x=null,T(),void P();if(!x){let n=I({x:t.offsetX,y:t.offsetY});e.push(n),x=n,T(),P()}E=!0}),k.addEventListener("contextmenu",e=>e.preventDefault());let O=()=>{E=!1};document.addEventListener("mouseup",O);let N=()=>{k.width=k.clientWidth,k.height=k.clientHeight,P()};return window.addEventListener("resize",N),y.addEventListener("click",()=>o(e)),g.addEventListener("click",()=>o(null)),c.addEventListener("click",e=>{d.contains(e.target)||o(null)}),C.append(k,w),v.append(b,C),f.append(g,y),d.append(m,v,f),c.append(d),document.body.append(c),T(),N(),i}function j(e,t,n){let i=[];return n&&i.push("t="+encodeURIComponent(n)),i.push("s="+encodeURIComponent(e.map(e=>e.id).join("."))),"/custom-playlist/"+(t||"playlist.bplist")+"?"+i.join("&")}async function R(e,t={}){let n,i=new Promise(e=>n=e),s=!1,l=e=>{s||(s=!0,document.body.removeChild(o)),n(e)},o=p("playlist-modal"),c=p("content"),d=u("h2",null,"CREATE A PLAYLIST"),f=p("buttons"),y=u("button","done","Done"),v=g("#","button file",".bplist"),b=g("#","button oneclick","OneClick™"),C=p("scroller"),k=t.filename||"playlist.bplist";v.download=k;let S=m(null,"",50);S.type="number",S.min=1,S.max=e.length;let w=p("playlist count",["Number of items from the top to include in the playlist: ",S]),x=h(null,50),E=h(null,"0pp"),L=p("playlist count",["Estimated PP gain for top ",x," maps: ",E]),I=()=>{let n=S.value.trim(),i=r(!n||Number.isNaN(+n)?50:~~n,1,e.length);x.textContent=i;let s=e.slice(0,i),l=V(s.map(e=>({uid:e.uid,pp:e.estimatePP||0})));E.textContent="+"+a(Math.max(l-H,0),2)+"pp",v.href=j(s,k,t.title),b.href="bsplaylist://playlist/"+encodeURIComponent(v.href)};return S.addEventListener("input",I),I(),y.addEventListener("click",()=>l(null)),o.addEventListener("click",e=>{c.contains(e.target)||l(null)}),f.append(v,b,y),C.append(w,L),c.append(d,C,f),o.append(c),document.body.append(o),i}!function(){try{let e=JSON.parse(localStorage.getItem("peepee-custom-curve"));Array.isArray(e)&&(F=e)}catch(e){}}();let U={},_={},K={},W=Date.now(),J=0,Y=k(),H=0;function $(e,t){let n=t.querySelector("h5.title"),i=n&&n.textContent.trim();if(!i)throw new Error("Invalid Profile");let a=t.querySelector(".avatar img"),r=n.querySelector("img"),s=t.querySelector("h5.title ~ ul"),l=s&&s.textContent||"",o=l.match(/#([\d,]+) /),c=l.match(/([\d,.]+)pp/);return{id:e,name:i,avatar:x(a),country:x(r),rank:o?+o[1].replace(/\D/g,""):0,pp:c?+c[1].replace(/[^\d.]/g,""):0}}function X(e){if(!e)return;let t=e.querySelector("table.ranking.songs tbody");if(!t)throw new Error("Error while parsing results page - maybe scoresaber is having issues?");return[...t.querySelectorAll("tr")].map(e=>{let t=e.querySelector('a[href*="/leaderboard/"]'),n=t&&t.href.match(/\/leaderboard\/(\d+)/);if(!n)return;let i=+n[1],a=e.querySelector(".ppValue"),r=a&&+a.textContent,s=e.querySelector(".rank"),l=s&&s.textContent.match(/#?([\d,]+)/),o=e.querySelector(".time"),c=Date.now();if(o){let e=(o.title||"").replace(/^.*(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2}).*$/,"$1T$2Z");c=+new Date(e)||c}let d=e.querySelector(".ppWeightedValue"),u=d&&d.textContent.match(/([\d.]+)/),p=e.querySelector(".scoreBottom"),h=p&&p.textContent.match(/([\d.]+)%/),m=h&&+h[1]||0,f=p&&p.textContent.match(/\(([^)]+)\)/),g=S(f&&f[1]);return{uid:i,rank:l&&+l[1].replace(/\D/g,"")||1/0,at:c,userPP:r,weighted:u&&+u[1]||0,score:m*g,modScore:m}}).filter(e=>e)}async function z(e,t){if(!e)throw new Error("No user ID specified");if((t=t||{}).useCache)try{let t=JSON.parse(localStorage.getItem("cached-"+e));if(t)return t}catch(e){}let n,i=1,a={};for(let r=!0;r;i++){"function"==typeof t.onProgress&&t.onProgress(i);let s=await C(e,i);1===i&&(n=$(e,s));let l=X(s);if(!l)break;l=l.filter(e=>e.userPP);let o=l.length;l=l.map(e=>{let t=K[e.uid];return t&&Object.assign({},t,e)}).filter(e=>e),l.forEach(e=>a[e.uid]=e),8===o?await v(200):r=!1}if(t.useCache)try{localStorage.setItem("cached-"+e,JSON.stringify({user:n,scores:a}))}catch(e){}return{user:n,scores:a}}function G(e,t){ge.elements=Object.values(t),fe.elements=e.list.filter(e=>!Object.prototype.hasOwnProperty.call(t,e.uid)).map(e=>Object.assign({},e)),ge.update(),fe.update(),ie(),te.parentElement.classList.add("show")}function V(e){let t=e.map(e=>e.uid),n=Object.values(_).filter(e=>!t.includes(e.uid)).map(e=>e.userPP).concat(e.map(e=>e.pp));n.sort((e,t)=>t-e);let i=1;return n.reduce((e,t,n)=>e+t*(i*=n?.965:1),0)}function Z(e,t){return V([{uid:e,pp:t}])}function Q(e,n){if(e.score&&e.score>=n)return e.estimateScore=e.score,e.estimatePP=e.userPP,void(e.estimateFull=H);e.estimateScore=n,e.estimatePP=e.pp*w(n,t),e.estimateFull=Z(e.uid,e.estimatePP)}function ee(e){let t=Date.now(),n=Object.values(_),i=Math.max(...n.map(e=>e.stars)),a=n.reduce((n,i)=>{let a=2*Math.abs(e-i.stars),r=e>i.stars?a*a*a:1,s=i.at||t,l=1/(1+a*(1+Math.max(t-s,0)/1296e6)*r);return n.weight+=l,n.sum+=i.score*l,n},{weight:0,sum:0}),r=a.weight?a.sum/a.weight:0;if(e>i){let t=2*Math.abs(e-i);r/=1+t*t}return r}let te=document.getElementById("score-est-curve"),ne=te.getContext("2d");function ie(e,t){t=t||{};let n=(e=e||ne).canvas;e.clearRect(0,0,n.width,n.height),t.background&&(e.fillStyle=!0===t.background?"#1e1f26":t.background,e.fillRect(0,0,n.width,n.height)),e.strokeStyle="white";let i="number"==typeof t.numPoints?t.numPoints:100,a=t.maxStars||15,r=t.maxPercentage||1.12,s=t.marginX||34,l=t.marginY||20;e.fillStyle="white",e.font='12px Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif',e.textBaseline="middle",e.textAlign="right",[...Array(5)].forEach((t,i)=>{i+=1,e.fillText(20*i+"%",s-4,(n.height-l)*(1-i/5/r),s-4)}),e.textBaseline="top",e.textAlign="left",e.fillText("star diff",0,n.height-l+4),e.textAlign="center",[...Array(a-1)].forEach((t,i)=>{let r=i+1;e.fillText(r,s+(n.width-s)*r/a,n.height-l+4)}),e.strokeStyle="rgba(255, 255, 255, .1)",e.beginPath(),[...Array(11)].forEach((t,i)=>{i+=1;let a=(n.height-l)*(1-i/10/r);e.moveTo(s,a),e.lineTo(n.width,a)}),e.stroke(),e.strokeStyle="white",e.beginPath(),e.moveTo(s,0),e.lineTo(s,n.height-l),e.lineTo(n.width,n.height-l),e.stroke(),e.fillStyle=t.playerSongsColor||"rgba(120, 10, 0, .9)",e.globalCompositeOperation="lighter",Object.values(_).forEach(t=>{let i=s+t.stars/a*(n.width-s),o=(n.height-l)*(1-t.score/100/r);e.fillRect(i-1,o-1,2,2)}),e.globalCompositeOperation="source-over",e.beginPath();for(let t=0;t<i;t++){let o=t/(i-1),c=ee(o*a)/100,d=s+o*(n.width-s),u=(n.height-l)*(1-c/r);e.lineTo(d,u)}e.stroke()}let ae=document.getElementById("last-update");let re={avatar:document.querySelector(".player .avatar"),flag:document.querySelector(".player .flag"),name:document.querySelector(".player .name"),rank:document.querySelector(".player .rank"),pp:document.querySelector(".player .pp"),best:document.querySelector(".player .stats .best"),median:document.querySelector(".player .stats .median")};function se(){re.avatar.style.backgroundImage="url("+U.avatar+")",re.flag.style.backgroundImage="url("+U.country+")",re.name.textContent=U.name,re.name.href="https://scoresaber.com/u/"+U.id,re.rank.textContent=U.rank.toLocaleString(),re.pp.textContent=U.pp.toLocaleString();let e=Object.values(_).map(e=>e.rank).sort((e,t)=>e-t),t=e[~~(e.length/2)]||0,n=e[0]||0,i=e.findIndex(e=>e!==n);-1===i&&(i=e.length),re.best.textContent=n.toLocaleString(),re.best.title=i.toLocaleString()+" leaderboard"+(1===i?"":"s"),re.median.textContent=t.toLocaleString()}let le=0;class oe{constructor(e){this.list=e,this.async=!1,this.name="???",this.id="unknown"}createOptionsMarkup(){}init(){}run(e){Q(e,0)}}let ce={};class de extends oe{constructor(e){super(e),this.name="Custom curve",this.id="custom-curve"}createOptionsMarkup(){let e=p("custom-curve-sort-buttons"),t=u("button","custom-curve-edit","edit curve");return t.addEventListener("click",async()=>{let e=await B(F);e&&async function(e){F=e;try{localStorage.setItem("peepee-custom-curve",JSON.stringify(e))}catch(e){}[ge,fe].forEach(e=>{e.method instanceof de&&e.update()})}(e)}),e.append(t),e}run(e){Q(e,100*w(e.stars,F))}}let ue=[class extends oe{constructor(e){super(e),this.name="Score est.",this.id="estimate"}run(e){Q(e,ee(e.stars))}},class extends oe{constructor(e){super(e),this.async=!0,this.name="Score at rank",this.id="rank"}createOptionsMarkup(){let e=u("form","rank-form");e.addEventListener("submit",e=>e.preventDefault()),this.rankInput=u("input","rank-input"),this.rankInput.type="text",this.rankInput.placeholder=(U.rank||1).toLocaleString()+" (desired rank)",this.rankInput.addEventListener("change",()=>{this.list.method===this&&this.list.update()}),e.appendChild(this.rankInput);let t=u("button","rank-submit");return t.type="submit",e.appendChild(t),e}init(e){e.sort((e,t)=>t.stars-e.stars),e.forEach(e=>Q(e,0)),this.rankInput.placeholder=(U.rank||1).toLocaleString()+" (desired rank)",this.rank=~~+this.rankInput.value.replace(/,/g,""),(!this.rank||this.rank<=0)&&(this.rank=U.rank||9999999),le=0}async run(e,t){let n=this.rank,i="scoreAtRank"+n,a=!1;if(!Object.prototype.hasOwnProperty.call(e,i)){let t=0,r=e.scores;"string"==typeof r&&(r=+r.replace(/,/g,"")||1/0),n<=r+100&&n<(+e.rank||1/0)&&(t=await async function e(t,n,i=2){if(!t||!n)return console.log("Invalid score at rank request",t,n),0;let a=Math.ceil(n/12),r=n-12*(a-1);try{let e=await b("/proxy/leaderboard/"+t+"?page="+(a||1));if(!e)return 0;let n=e.querySelector(".ranking tbody tr:nth-child("+r+")");if(!n)return 0;let i=n.querySelector(".percentage"),s=(i&&i.textContent||"").match(/[\d.]+/);if(!s)return 0;let l=n.querySelector(".mods"),o=S(l&&l.textContent),c=i&&i.querySelector("span[style*=tomato]");return s[0]*o*(c?110/115:1)}catch(a){return i-- >0?(await v(1e3),e(t,n,i)):(console.log("Error getting score at rank",a),0)}}(e.uid,n),le++,a=!0),e[i]=t}if(!t()){if(Q(e,e[i]||0),le>=100)return"PAUSE_UPDATE";a&&await v(200)}}},class extends oe{constructor(e){super(e),this.name="Fixed score",this.id="raw",this.score=94.333333}createOptionsMarkup(){let e=u("form","fixed-form");e.addEventListener("submit",e=>e.preventDefault()),this.fixedInput=u("input","fixed-input"),this.fixedInput.type="text",this.fixedInput.placeholder="94.3333%",this.fixedInput.maxLength=10,this.fixedInput.addEventListener("change",()=>{this.list.method===this&&this.list.update()}),e.appendChild(this.fixedInput);let t=u("button","fixed-submit");return t.type="submit",e.appendChild(t),e}init(){this.score=parseFloat(this.fixedInput.value.trim())||94.333333,this.score<=0&&(this.score=.01)}run(e){Q(e,this.score)}},de,class extends oe{constructor(e){super(e),this.name="Compare",this.async=!0,this.id="compare"}createOptionsMarkup(){let e=u("form","compare-form");e.addEventListener("submit",e=>e.preventDefault()),this.compareInput=u("input","compare-input"),this.compareInput.type="text",this.compareInput.placeholder="compared profile url";let t=()=>{let t=this.compareInput.value.match(/\d{5,}/);t?(this.compareInput.value=t[0],this.list.method===this&&this.list.update()):i(e,"invalid")};this.compareInput.addEventListener("change",t),this.compareInput.addEventListener("paste",()=>setTimeout(t,0)),this.compareInput.addEventListener("focus",()=>this.compareInput.select()),e.appendChild(this.compareInput);let n=u("button","compare-auto","auto");n.type="button",n.addEventListener("click",async()=>{n.disabled=!0;let e=1===U.rank?2:Math.floor(.9*U.rank),i=await async function e(t,n=2){if(!t)return console.log("Invalid player at rank request",t),null;let i=Math.ceil(t/50),a=t-50*(i-1);try{let e=await b("/proxy/global/"+(i||1));if(!e)return null;let t=e.querySelector(".ranking tbody tr:nth-child("+a+")");if(!t)return null;let n=t.querySelector(".player a"),r=(n&&n.href||"").match(/\/u\/(\d+)/);return r?r[1]:null}catch(i){return n-- >0?(await v(1e3),e(t,n)):(console.log("Error getting player at rank",i),null)}}(e);this.compareInput.value=i||"",n.disabled=!1,t()}),e.appendChild(n);let a=u("button","compare-submit");return a.type="submit",e.appendChild(a),e}async init(e){e.sort((e,t)=>t.pp-e.pp),e.forEach(e=>Q(e,0)),this.userId=this.compareInput.value,ce[this.userId]||(ce[this.userId]=z(this.userId));try{let e=await ce[this.userId];this.user=e.user,this.scores=e.scores}catch(e){this.user={},this.scores={}}}run(e){Q(e,(this.scores[e.uid]||{}).score||0)}}],pe=ue,he=ue.concat(class extends oe{constructor(e){super(e),this.name="Worst rank",this.id="worstrank"}run(e){Q(e,ee(e.stars))}sort(e){return e.sort((e,t)=>(t.rank||0)-(e.rank||0)||t.pp-e.pp)}},class extends oe{constructor(e){super(e),this.name="Best rank",this.id="bestrank"}run(e){Q(e,ee(e.stars))}sort(e){return e.sort((e,t)=>(e.rank||0)-(t.rank||0)||t.pp-e.pp)}},class extends oe{constructor(e){super(e),this.name="Worst score",this.id="worstscore"}run(e){Q(e,ee(e.stars))}sort(e){return e.sort((e,t)=>(e.score||0)-(t.score||0)||e.pp-t.pp)}},class extends oe{constructor(e){super(e),this.name="Oldest score",this.id="oldestscore"}run(e){Q(e,ee(e.stars))}sort(e){return e.sort((e,t)=>(e.at||0)-(t.at||0)||e.pp-t.pp)}});class me{constructor(e,t,n,i=[]){this.elem=e,this.title=t,this.selection=[],this.methods=n.map(e=>new e(this)),this.method=this.methods[0],this.elements=i,this.displayed=20,e.innerHTML="";let a=p("list-header");this.selectionTooltip=p("list-selection-tooltip");let r=p("first-line");this.mapCount=h("selection-map-count","0 maps");let s=u("button","selection-clear","clear");s.onclick=this.clearSelection.bind(this),r.append("Selection: ",this.mapCount," (",s,")"),this.selectionTooltip.appendChild(r),this.selectionTooltipPP=p("line","+0.00pp"),this.selectionTooltip.appendChild(this.selectionTooltipPP),this.selectionTooltipBplist=g("#","bplist",".bplist"),this.selectionTooltipOneClick=g("#","oneclick","OneClick");let l=p("selection-playlist",[this.selectionTooltipBplist," - ",this.selectionTooltipOneClick]);this.selectionTooltip.appendChild(l),a.appendChild(this.selectionTooltip);let o=p("list-title",t);this.titleEl=o;let c=u("button","playlist","","Create a playlist");c.onclick=this.createPlaylist.bind(this),o.appendChild(c),a.appendChild(o);let d=p("method-wrapper"),m=p("method"),y=u("select");this.methods.forEach((e,t)=>{let n=f(e.name,t);y.appendChild(n)}),y.onchange=()=>{this.changeMethod(this.methods[y.value])},m.appendChild(y);let v=u("button","unpause","","Keep going");v.addEventListener("click",()=>{this.updating||this.update()}),m.appendChild(v),d.appendChild(m),this.methods.forEach(e=>{let t=e.createOptionsMarkup();t&&d.appendChild(t)}),a.appendChild(d),e.appendChild(a),this.content=p("list-content"),this.content.addEventListener("click",this.onContentClick.bind(this)),this.content.addEventListener("contextmenu",this.onContextMenu.bind(this)),this.content.addEventListener("scroll",this.onScroll.bind(this)),e.appendChild(this.content),this.updateSelectionTooltip(),this.update(),this.onScroll()}getPlaylistName(){let e=new Date,t=e.getFullYear()+"-"+o(e.getMonth()+1)+"-"+o(e.getDate()),n=this.title.replace(/[\W-]+/g,"-").replace(/^-|-$/g,"").toLowerCase();return{title:this.title+" ("+t+")",filename:n+"-"+t+".bplist"}}createPlaylist(){return R(this.elements.filter(this.filter).filter((e,t,n)=>e.id&&n.findIndex(t=>t.id===e.id)===t),this.getPlaylistName())}changeMethod(e){this.method!==e&&(this.method&&this.elem.classList.remove("method-"+this.method.id),this.content.scrollTop=0,this.displayed=20,this.method=e,this.method&&this.elem.classList.add("method-"+this.method.id),this.update(),this.onScroll())}clearSelection(){this.selection=[],this.updateSelectionTooltip(),[...this.content.querySelectorAll(".element.selected")].forEach(e=>e.classList.remove("selected"))}updateSelectionTooltip(){let e=this.selection.map(e=>this.elements.find(t=>e===t.uid)).filter(e=>e);this.selection=e.map(e=>e.uid);let t=e.length;this.mapCount.textContent=t+" map"+(1===t?"":"s");let n=V(e.map(e=>({uid:e.uid,pp:e.estimatePP})));this.selectionTooltipPP.textContent="+"+a(Math.max(n-H,0),2)+"pp",this.selectionTooltip.classList[t?"add":"remove"]("show");let i=this.getPlaylistName();this.selectionTooltipBplist.href=j(e,i.filename,i.title),this.selectionTooltipOneClick.href="bsplaylist://playlist/"+encodeURIComponent(this.selectionTooltipBplist.href)}getClosestElement(e){for(;e&&!e.classList.contains("element")&&this.content.contains(e);)e=e.parentElement;return e&&e.classList.contains("element")?e:null}toggleSelection(e,t){if(!e)return;let n=this.selection.includes(e);if("boolean"!=typeof t&&(t=!n),t===n)return;t?this.selection.push(e):this.selection=this.selection.filter(t=>t!==e);let i=this.content.querySelector('[data-uid="'+e+'"]');i&&i.classList[t?"add":"remove"]("selected"),this.updateSelectionTooltip()}onContentClick(e){if((e.ctrlKey||e.metaKey)&&!e.target.matches("a, button")){let t=this.getClosestElement(e.target),n=t&&+t.getAttribute("data-uid");this.toggleSelection(n)}}onContextMenu(e){if(e.ctrlKey||e.metaKey||e.target.matches("a, button")||!window.ContextMenu)return;let t=this.getClosestElement(e.target),n=t&&+t.getAttribute("data-uid");if(!n)return;e.preventDefault(),e.stopPropagation();let i=this.selection.includes(n);window.ContextMenu.show([{text:(i?"Deselect":"Select")+" map",shortcut:"Ctrl+Click",action:()=>this.toggleSelection(n)},{text:"Screw this (hide map)",action:()=>async function(e){let t=N.hiddenMaps||[];t.push(e),D(Object.assign(N,{hiddenMaps:t}))}(n)},{separator:!0},{text:"Show help",action:be}],{x:e.clientX,y:e.clientY})}onScroll(){this.content.scrollTop+this.content.clientHeight>this.content.scrollHeight-50&&this.displayMore()}displayMore(){this.displayed>=this.elements.length||(this.displayed+=20,this.refresh())}createMarkup(e){let t=p("element");t.setAttribute("data-uid",e.uid);let i=p("left"),r=p("pic");r.style.backgroundImage="url(https://scoresaber.com/imports/images/songs/"+e.id+".png)",i.appendChild(r);let s=p("name-group"),l=p("name-and-artist");l.title=e.name+" - "+e.artist,l.appendChild(h("name",(e.name||"")+" ")),l.appendChild(h("sep")),l.appendChild(h("artist",e.artist)),s.appendChild(l),s.appendChild(p("mapper",e.mapper));let o=e.diff||"Easy",m=n[o]||{},f=p("difficulty-and-score");if(f.appendChild(h("difficulty "+(m.className||o.toLowerCase()),(m.display||o)+" ")),e.score||0===e.score){let t=h("score-and-rank");if(t.appendChild(h("score",[a(e.score,2),h("percent-sign","% ")])),e.at){let n=new Date(e.at);t.appendChild(h("at",d(n)+" ",c(n)))}t.appendChild(h("sep")),t.appendChild(h("rank",e.rank.toLocaleString())),f.appendChild(t)}s.appendChild(f),i.appendChild(s),t.appendChild(i);let y=p("middle");y.appendChild(p("pot-title","Potential")),e._potScore=p("pot-score"),y.appendChild(e._potScore);let v=p("pot-pp");e._potPP=h("raw"),v.appendChild(e._potPP),e._potInc=h("increase",null,"Total (weighted) pp change"),v.appendChild(e._potInc),y.appendChild(v),t.appendChild(y);let b=p("right"),C=p("important");C.appendChild(p("star-difficulty",e.stars,"Star difficulty")),void 0!==e.upvotes&&C.appendChild(p("upvotes",e.upvotes,"Upvotes")),void 0!==e.downvotes&&C.appendChild(p("downvotes",e.downvotes,"Downvotes")),b.appendChild(C);let k=p("secondary");e.duration&&k.appendChild(p("duration",function(e){let t=e.duration/e.bpm,n=Math.floor(t);return n+":"+("0"+Math.round(60*(t-n))).slice(-2)}(e),"Duration")),k.appendChild(p("bpm",a(e.bpm,2),"BPM")),b.appendChild(k);let S=p("links");if(e.beatSaverKey){let t=u("button","bsr",null,"Copy !bsr request");t.addEventListener("click",()=>function(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}("!bsr "+e.beatSaverKey)),S.appendChild(t)}e.download&&S.appendChild(g(e.download,"download",null,"Download map","_blank")),e.beatSaverKey&&(S.appendChild(g("beatsaver://"+e.beatSaverKey,"oneclick",null,"OneClick™ install")),S.appendChild(g("https://beatsaver.com/beatmap/"+e.beatSaverKey,"beatsaver",null,"Open on BeatSaver","_blank"))),S.appendChild(g("https://scoresaber.com/leaderboard/"+e.uid,"leaderboards",null,"ScoreSaber leaderboard","_blank")),b.appendChild(S),t.appendChild(b),e.markup=t}async update(){let e=this.elements,t=e.length;this.titleEl.title=t+" leaderboard"+(1===t?"":"s");let n=this.method,i=Date.now();this.elem.classList.remove("paused"),this.updating&&this.elem.classList.remove("loading"),this.updating=i,n.async&&this.elem.classList.add("loading"),await n.init(e),this.refresh();let a=()=>this.updating!==i;for(let t=0;t<e.length;t++){let i=await n.run(e[t],a);if(n.async){if(a())return;this.refresh()}if("PAUSE_UPDATE"===i){this.elem.classList.add("paused");break}}n.async?this.elem.classList.remove("loading"):this.refresh(),this.updating=!1}defaultSort(e){return e.sort((e,t)=>(t.estimateFull||0)-(e.estimateFull||0)||t.pp-e.pp)}filter(e){return(!N.hiddenMaps||!N.hiddenMaps.includes(e.uid))&&(!(e.estimateScore<N.scoreFrom||e.estimateScore>N.scoreTo)&&!(e.stars<N.starsFrom||e.stars>N.starsTo))}refresh(){for(;this.content.firstChild;)this.content.removeChild(this.content.firstChild);let e=this.method.sort||this.defaultSort;this.elements=e(this.elements),this.elements.filter(this.filter).slice(0,this.displayed).forEach(e=>{e.markup||this.createMarkup(e),void 0===e.estimateScore&&Q(e,0),e._potScore.textContent=a(e.estimateScore,2),e._potPP.textContent=a(e.estimatePP,2),e._potInc.textContent=a(Math.max(e.estimateFull-H,0),2),this.content.appendChild(e.markup)})}}let fe=new me(document.querySelector(".list.unplayed"),"Not played",pe),ge=new me(document.querySelector(".list.played"),"To improve",he);async function ye(e){if(e&&e.preventDefault&&e.preventDefault(),E.classList.contains("loading"))return;let t=L.value.match(/\d{5,}/);if(!t)return void i(E,"invalid");let n=t[0];I.textContent="Getting user infos...",E.classList.add("loading"),L.disabled=!0,W=Date.now();try{let e=await Y;K=e.list.reduce((e,t)=>(e[t.uid]=t,e),{});let t=await z(n,{useCache:location.search.includes("debug"),onProgress:e=>I.textContent="Getting scores page "+e+"..."});U=t.user,_=t.scores,H=Z(0,0),O(U),se(),G(e,_),document.body.classList.add("step-results","user-"+n)}catch(e){console.error(e),i(E,"invalid")}L.disabled=!1,E.classList.remove("loading")}E.addEventListener("submit",ye),L.addEventListener("paste",()=>setTimeout(ye,0)),L.addEventListener("focus",()=>L.select());let ve=document.getElementById("show-help");function be(){ve.checked=!ve.checked}document.getElementById("back").addEventListener("click",()=>{L.value="",document.body.classList.remove("step-results")}),document.getElementById("refresh").addEventListener("click",(async function(){if(!U||!U.id)return;document.body.classList.add("refreshing");try{let e=W;W=Date.now();let t=await async function(e,t){let n,i=1,a={};for(let r=!0;r;i++){let s=await C(e,i,2);1===i&&(n=$(e,s));let l=X(s);if(!l)break;let o=Math.min(...l.map(e=>e.at));l=l.map(e=>{let t=K[e.uid];return t&&Object.assign({},t,e)}).filter(e=>e),l.forEach(e=>a[e.uid]=e),o>=t?await v(200):r=!1}return{user:n,scores:a}}(U.id,e);U=t.user,Object.assign(_,t.scores),O(U),H=Z(0,0),se()}catch(e){}let e=k(new Date(J));try{await e,Y=e}catch(e){}G(await Y,_),document.body.classList.remove("refreshing")})),document.getElementById("show-filters").addEventListener("click",async()=>{let e=await A(N);e&&D(e)}),document.getElementById("export-curve").addEventListener("click",()=>{let e=document.createElement("canvas");e.width=800,e.height=400,ie(e.getContext("2d"),{background:!0,numPoints:500});let t=(U.name||"").replace(/[\W-]+/g,"-").replace(/^-|-$/g,"").toLowerCase();y(e.toDataURL(),t+"-score-curve.png")})}();
!async function(){const e={GN:.04,DA:.02,FS:.08,NF:-.5,NO:-.05,NB:-.1,SS:-.3,NA:-.3},t=[{at:0,value:0},{at:45,value:.015},{at:50,value:.03},{at:55,value:.06},{at:60,value:.105},{at:65,value:.16},{at:68,value:.24},{at:70,value:.285},{at:80,value:.563},{at:84,value:.695},{at:88,value:.826},{at:94.5,value:1.015},{at:95,value:1.046},{at:100,value:1.12},{at:110,value:1.18},{at:114,value:1.25}],n={ExpertPlus:{className:"expert-plus",display:"Expert+"}};function a(e,t){e&&(e.classList.remove(t),e.offsetWidth,e.classList.add(t))}function i(e,t=0){return e.toFixed(t).replace(/\.?0*$/,"")}function r(e){return("0"+e).slice(-2)}const s=function(){const e=864e5;let t=(e,t)=>~~(e/t),n=(e,t)=>e+" "+t+(1!==e&&-1!==e?"s":"");return a=>function(a,i){let r=i-a,s=Math.abs(r);if(s<6e4)return n(t(r,1e3),"second");if(s<36e5)return n(t(r,6e4),"minute");if(s<e)return n(t(r,36e5),"hour");if(s<2592e6)return n(t(r,e),"day");let l=function(e,t){let n=t.getFullYear()-e.getFullYear();return t.getMonth()-e.getMonth()+12*n}(a,i);return Math.abs(l)<12?n(l,"month"):n(~~(l/12),"year")}(a,new Date)+" ago"}();function l(e,t,n,a){let i=document.createElement(e);return null!=t&&(i.className=t),null!=n&&(i.textContent=n),null!=a&&(i.title=a),i}let o=l.bind(null,"div"),c=l.bind(null,"span"),d=(e,t,n,a,i)=>{let r=l("a",t,n,a);return r.href=e,i&&(r.target=i),r};function u(e,t){let n=document.createElement("a");n.download=t,n.href=e,n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}async function p(e){await new Promise(t=>setTimeout(t,e))}function h(...e){return fetch(...e).then(e=>e.json())}async function m(...e){return fetch(...e).then(e=>e.ok?e.text():Promise.reject()).then(e=>{if(-1===e.indexOf("<html"))throw new Error("not an HTML page: "+e);return(new DOMParser).parseFromString(e,"text/html")})}async function f(e,t,n=1,a=2){return m("/proxy/u/"+e+"?sort="+n+"&page="+(t||1)).catch(async i=>{if(a-- >0)return await p(1e3),f(e,t,n,a);throw i})}function g(t){return t?t.split(",").reduce((t,n)=>t+(e[n.trim()]||0),1):1}function y(e){if(!e)return null;let t=e.getAttribute("src");return t.match(/^https?:\/\//)||(t="https://scoresaber.com"+("/"===t[0]?"":"/")+t),t}WebFont.load({custom:{families:["NeonTubes"]}});let A=document.getElementById("user"),C=document.getElementById("profile"),b=document.getElementById("user-fetch-info"),v=[];try{let e=JSON.parse(localStorage.getItem("history"));Array.isArray(e)&&(v=e)}catch(e){}let k=document.querySelector(".history");function w(){k.innerHTML="",v.slice(0,5).forEach(e=>{if(!e||!e.avatar||null==e.rank||!e.name)return;let t=o("line");t.onclick=()=>{C.disabled||(C.value=e.id,te())};let n=o("avatar");n.style.backgroundImage="url("+e.avatar+")",t.appendChild(n),t.appendChild(o("rank",e.rank.toLocaleString())),t.appendChild(o("name",e.name)),k.appendChild(t)})}function I(e){v=v.filter(t=>t&&t.id!==e.id),v.unshift(e),v=v.slice(0,5);try{localStorage.setItem("history",JSON.stringify(v))}catch(e){}w()}w();let S={},x={},E={},P=Date.now(),L=0,O=h("/ranked"),T=0;function M(e,t){let n=t.querySelector("h5.title"),a=n&&n.textContent.trim();if(!a)throw new Error("Invalid Profile");let i=t.querySelector(".avatar img"),r=n.querySelector("img"),s=t.querySelector("h5.title ~ ul"),l=s&&s.textContent||"",o=l.match(/#([\d,]+) /),c=l.match(/([\d,.]+)pp/);return{id:e,name:a,avatar:y(i),country:y(r),rank:o?+o[1].replace(/\D/g,""):0,pp:c?+c[1].replace(/[^\d.]/g,""):0}}function D(e){if(!e)return;let t=e.querySelector("table.ranking.songs tbody");if(!t)throw new Error("Error while parsing results page - maybe scoresaber is having issues?");return[...t.querySelectorAll("tr")].map(e=>{let t=e.querySelector('a[href*="/leaderboard/"]'),n=t&&t.href.match(/\/leaderboard\/(\d+)/);if(!n)return;let a=+n[1],i=e.querySelector(".ppValue"),r=i&&+i.textContent,s=e.querySelector(".rank"),l=s&&s.textContent.match(/#?([\d,]+)/),o=e.querySelector(".time"),c=Date.now();if(o){let e=(o.title||"").replace(/^.*(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2}:\d{2}).*$/,"$1T$2Z");c=+new Date(e)||c}let d=e.querySelector(".ppWeightedValue"),u=d&&d.textContent.match(/([\d.]+)/),p=e.querySelector(".scoreBottom"),h=p&&p.textContent.match(/([\d.]+)%/),m=h&&+h[1]||0,f=p&&p.textContent.match(/\(([^)]+)\)/),y=g(f&&f[1]);return{uid:a,rank:l&&+l[1].replace(/\D/g,"")||1/0,at:c,userPP:r,weighted:u&&+u[1]||0,score:m*y,modScore:m}}).filter(e=>e)}async function q(e,t){if(!e)throw new Error("No user ID specified");if((t=t||{}).useCache)try{let t=JSON.parse(localStorage.getItem("cached-"+e));if(t)return t}catch(e){}let n,a=1,i={};for(let r=!0;r;a++){"function"==typeof t.onProgress&&t.onProgress(a);let s=await f(e,a);1===a&&(n=M(e,s));let l=D(s);if(!l)break;l=l.filter(e=>e.userPP);let o=l.length;l=l.map(e=>{let t=E[e.uid];return t&&Object.assign({},t,e)}).filter(e=>e),l.forEach(e=>i[e.uid]=e),8===o?await p(200):r=!1}if(t.useCache)try{localStorage.setItem("cached-"+e,JSON.stringify({user:n,scores:i}))}catch(e){}return{user:n,scores:i}}function F(e,t){$.elements=Object.values(t),_.elements=e.list.filter(e=>!Object.prototype.hasOwnProperty.call(t,e.uid)).map(e=>Object.assign({},e)),$.update(),_.update(),V()}function B(e){let t=e.map(e=>e.uid),n=Object.values(x).filter(e=>!t.includes(e.uid)).map(e=>e.userPP).concat(e.map(e=>e.pp));n.sort((e,t)=>t-e);let a=1;return n.reduce((e,t,n)=>e+t*(a*=n?.965:1),0)}function Q(e,t){return B([{uid:e,pp:t}])}function N(e,n){if(e.score&&e.score>=n)return e.estimateScore=e.score,e.estimatePP=e.userPP,void(e.estimateFull=T);e.estimateScore=n,e.estimatePP=e.pp*function(e,t){if(!e||e<=0)return 0;let n=t.findIndex(t=>t.at>=e);if(-1===n)return t[t.length-1].value;if(!n)return t[0].value;let a=t[n-1],i=t[n],r=(e-a.at)/(i.at-a.at);return a.value+(i.value-a.value)*r}(n,t),e.estimateFull=Q(e.uid,e.estimatePP)}function U(e){let t=Date.now(),n=Object.values(x),a=Math.max(...n.map(e=>e.stars)),i=n.reduce((n,a)=>{let i=2*Math.abs(e-a.stars),r=e>a.stars?i*i*i:1,s=a.at||t,l=1/(1+i*(1+Math.max(t-s,0)/1296e6)*r);return n.weight+=l,n.sum+=a.score*l,n},{weight:0,sum:0}),r=i.weight?i.sum/i.weight:0;if(e>a){let t=2*Math.abs(e-a);r/=1+t*t}return r}function j(e,t){let n=new Date,a=n.getFullYear()+"-"+r(n.getMonth()+1)+"-"+r(n.getDate()),i={playlistTitle:t+" ("+a+")",playlistAuthor:"Peepee",image:"data:image/png;base64,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",songs:e.map(e=>({hash:e.id,songName:e.name}))},s=t.replace(/[\W-]+/g,"-").replace(/^-|-$/g,"").toLowerCase();u("data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i)),s+"-"+a+".bplist")}let K=document.getElementById("score-est-curve").getContext("2d");function V(e,t){t=t||{};let n=(e=e||K).canvas;e.clearRect(0,0,n.width,n.height),t.background&&(e.fillStyle=!0===t.background?"#1e1f26":t.background,e.fillRect(0,0,n.width,n.height)),e.strokeStyle="white";let a=t.numPoints||100,i=t.maxStars||15,r=t.maxPercentage||1.12,s=t.marginX||34,l=t.marginY||20;e.fillStyle="white",e.font='12px Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif',e.textBaseline="middle",e.textAlign="right",[...Array(5)].forEach((t,a)=>{a+=1,e.fillText(20*a+"%",s-4,(n.height-l)*(1-a/5/r),s-4)}),e.textBaseline="top",e.textAlign="left",e.fillText("star diff",0,n.height-l+4),e.textAlign="center",[...Array(i-1)].forEach((t,a)=>{let r=a+1;e.fillText(r,s+(n.width-s)*r/i,n.height-l+4)}),e.strokeStyle="rgba(255, 255, 255, .1)",e.beginPath(),[...Array(11)].forEach((t,a)=>{a+=1;let i=(n.height-l)*(1-a/10/r);e.moveTo(s,i),e.lineTo(n.width,i)}),e.stroke(),e.strokeStyle="white",e.beginPath(),e.moveTo(s,0),e.lineTo(s,n.height-l),e.lineTo(n.width,n.height-l),e.stroke(),e.fillStyle="rgba(120, 10, 0, .9)",e.globalCompositeOperation="lighter",Object.values(x).forEach(t=>{let a=s+t.stars/i*(n.width-s),o=(n.height-l)*(1-t.score/100/r);e.fillRect(a-1,o-1,2,2)}),e.globalCompositeOperation="source-over",e.beginPath();for(let t=0;t<a;t++){let o=t/(a-1),c=U(o*i)/100,d=s+o*(n.width-s),u=(n.height-l)*(1-c/r);e.lineTo(d,u)}e.stroke()}let W={avatar:document.querySelector(".player .avatar"),flag:document.querySelector(".player .flag"),name:document.querySelector(".player .name"),rank:document.querySelector(".player .rank"),pp:document.querySelector(".player .pp"),best:document.querySelector(".player .stats .best"),median:document.querySelector(".player .stats .median")};function H(){W.avatar.style.backgroundImage="url("+S.avatar+")",W.flag.style.backgroundImage="url("+S.country+")",W.name.textContent=S.name,W.name.href="https://scoresaber.com/u/"+S.id,W.rank.textContent=S.rank.toLocaleString(),W.pp.textContent=S.pp.toLocaleString();let e=Object.values(x).map(e=>e.rank).sort((e,t)=>e-t),t=e[~~(e.length/2)]||0,n=e[0]||0,a=e.findIndex(e=>e!==n);-1===a&&(a=e.length),W.best.textContent=n.toLocaleString(),W.best.title=a.toLocaleString()+" leaderboard"+(1===a?"":"s"),W.median.textContent=t.toLocaleString()}let J=0;class G{constructor(e){this.list=e,this.async=!1,this.name="???",this.id="unknown"}createOptionsMarkup(){}init(){}run(e){N(e,0)}}let R={};let z=[class extends G{constructor(e){super(e),this.name="Score est.",this.id="estimate"}run(e){N(e,U(e.stars))}},class extends G{constructor(e){super(e),this.async=!0,this.name="Score at rank",this.id="rank"}createOptionsMarkup(){let e=l("form","rank-form");e.addEventListener("submit",e=>e.preventDefault()),this.rankInput=l("input","rank-input"),this.rankInput.type="text",this.rankInput.placeholder=(S.rank||1).toLocaleString()+" (desired rank)",this.rankInput.addEventListener("change",()=>{this.list.method===this&&this.list.update()}),e.appendChild(this.rankInput);let t=l("button","rank-submit");return t.type="submit",e.appendChild(t),e}init(e){e.sort((e,t)=>t.stars-e.stars),e.forEach(e=>N(e,0)),this.rankInput.placeholder=(S.rank||1).toLocaleString()+" (desired rank)",this.rank=~~+this.rankInput.value.replace(/,/g,""),(!this.rank||this.rank<=0)&&(this.rank=S.rank||9999999),J=0}async run(e,t){let n=this.rank,a="scoreAtRank"+n,i=!1;if(!Object.prototype.hasOwnProperty.call(e,a)){let t=0,r=e.scores;"string"==typeof r&&(r=+r.replace(/,/g,"")||1/0),n<=r+100&&n<(+e.rank||1/0)&&(t=await async function e(t,n,a=2){if(!t||!n)return console.log("Invalid score at rank request",t,n),0;let i=Math.ceil(n/12),r=n-12*(i-1);try{let e=await m("/proxy/leaderboard/"+t+"?page="+(i||1));if(!e)return 0;let n=e.querySelector(".ranking tbody tr:nth-child("+r+")");if(!n)return 0;let a=n.querySelector(".percentage"),s=(a&&a.textContent||"").match(/[\d.]+/);if(!s)return 0;let l=n.querySelector(".mods"),o=g(l&&l.textContent),c=a&&a.querySelector("span[style*=tomato]");return s[0]*o*(c?110/115:1)}catch(i){return a-- >0?(await p(1e3),e(t,n,a)):(console.log("Error getting score at rank",i),0)}}(e.uid,n),J++,i=!0),e[a]=t}if(!t()){if(N(e,e[a]||0),J>=100)return"PAUSE_UPDATE";i&&await p(200)}}},class extends G{constructor(e){super(e),this.name="Fixed score",this.id="raw",this.score=94.333333}createOptionsMarkup(){let e=l("form","fixed-form");e.addEventListener("submit",e=>e.preventDefault()),this.fixedInput=l("input","fixed-input"),this.fixedInput.type="text",this.fixedInput.placeholder="94.3333%",this.fixedInput.maxLength=10,this.fixedInput.addEventListener("change",()=>{this.list.method===this&&this.list.update()}),e.appendChild(this.fixedInput);let t=l("button","fixed-submit");return t.type="submit",e.appendChild(t),e}init(){this.score=parseFloat(this.fixedInput.value.trim())||94.333333,this.score<=0&&(this.score=.01)}run(e){N(e,this.score)}},class extends G{constructor(e){super(e),this.name="Compare",this.async=!0,this.id="compare"}createOptionsMarkup(){let e=l("form","compare-form");e.addEventListener("submit",e=>e.preventDefault()),this.compareInput=l("input","compare-input"),this.compareInput.type="text",this.compareInput.placeholder="compared profile url";let t=()=>{let t=this.compareInput.value.match(/\d{5,}/);t?(this.compareInput.value=t[0],this.list.method===this&&this.list.update()):a(e,"invalid")};this.compareInput.addEventListener("change",t),this.compareInput.addEventListener("paste",()=>setTimeout(t,0)),this.compareInput.addEventListener("focus",()=>this.compareInput.select()),e.appendChild(this.compareInput);let n=l("button","compare-auto","auto");n.type="button",n.addEventListener("click",async()=>{n.disabled=!0;let e=1===S.rank?2:Math.floor(.9*S.rank),a=await async function e(t,n=2){if(!t)return console.log("Invalid player at rank request",t),null;let a=Math.ceil(t/50),i=t-50*(a-1);try{let e=await m("/proxy/global/"+(a||1));if(!e)return null;let t=e.querySelector(".ranking tbody tr:nth-child("+i+")");if(!t)return null;let n=t.querySelector(".player a"),r=(n&&n.href||"").match(/\/u\/(\d+)/);return r?r[1]:null}catch(a){return n-- >0?(await p(1e3),e(t,n)):(console.log("Error getting player at rank",a),null)}}(e);this.compareInput.value=a||"",n.disabled=!1,t()}),e.appendChild(n);let i=l("button","compare-submit");return i.type="submit",e.appendChild(i),e}async init(e){e.sort((e,t)=>t.pp-e.pp),e.forEach(e=>N(e,0)),this.userId=this.compareInput.value,R[this.userId]||(R[this.userId]=q(this.userId));try{let e=await R[this.userId];this.user=e.user,this.scores=e.scores}catch(e){this.user={},this.scores={}}}run(e){N(e,(this.scores[e.uid]||{}).score||0)}}],Z=z,Y=z.concat(class extends G{constructor(e){super(e),this.name="Worst rank",this.id="worstrank"}run(e){N(e,U(e.stars))}sort(e){return e.sort((e,t)=>(t.rank||0)-(e.rank||0)||t.pp-e.pp)}},class extends G{constructor(e){super(e),this.name="Best rank",this.id="bestrank"}run(e){N(e,U(e.stars))}sort(e){return e.sort((e,t)=>(e.rank||0)-(t.rank||0)||t.pp-e.pp)}},class extends G{constructor(e){super(e),this.name="Worst score",this.id="worstscore"}run(e){N(e,U(e.stars))}sort(e){return e.sort((e,t)=>(e.score||0)-(t.score||0)||e.pp-t.pp)}},class extends G{constructor(e){super(e),this.name="Oldest score",this.id="oldestscore"}run(e){N(e,U(e.stars))}sort(e){return e.sort((e,t)=>(e.at||0)-(t.at||0)||e.pp-t.pp)}});class X{constructor(e,t,n,a=[]){this.elem=e,this.title=t,this.selection=[],this.methods=n.map(e=>new e(this)),this.method=this.methods[0],this.elements=a,this.displayed=20,e.innerHTML="";let i=o("list-header");this.selectionTooltip=o("list-selection-tooltip");let r=o("first-line");this.mapCount=c("selection-map-count","0 maps");let s=l("button","selection-clear","clear");s.onclick=this.clearSelection.bind(this),r.append("Selection: ",this.mapCount," (",s,")"),this.selectionTooltip.appendChild(r),this.selectionTooltipPP=o("line","+0.00pp"),this.selectionTooltip.appendChild(this.selectionTooltipPP);let d=l("button","selection-playlist","Make a playlist");d.onclick=this.createSelectionPlaylist.bind(this),this.selectionTooltip.appendChild(d),i.appendChild(this.selectionTooltip);let u=o("list-title",t);this.titleEl=u;let p=l("button","playlist","","Create a playlist");p.onclick=this.createPlaylist.bind(this),u.appendChild(p),i.appendChild(u);let h=o("method-wrapper"),m=o("method"),f=l("select");this.methods.forEach((e,t)=>{let n=((e,t)=>{let n=l("option");return n.textContent=e,n.value=t,n})(e.name,t);f.appendChild(n)}),f.onchange=()=>{this.changeMethod(this.methods[f.value])},m.appendChild(f);let g=l("button","unpause","","Keep going");g.addEventListener("click",()=>{this.updating||this.update()}),m.appendChild(g),h.appendChild(m),this.methods.forEach(e=>{let t=e.createOptionsMarkup();t&&h.appendChild(t)}),i.appendChild(h),e.appendChild(i),this.content=o("list-content"),this.content.addEventListener("click",this.onContentClick.bind(this)),this.content.addEventListener("scroll",this.onScroll.bind(this)),e.appendChild(this.content),this.updateSelectionTooltip(),this.update(),this.onScroll()}createPlaylist(){let e=+prompt("Number of items to include in the playlist",50);if(e)return j(this.elements.filter((e,t,n)=>e.id&&n.findIndex(t=>t.id===e.id)===t).slice(0,e),this.title)}createSelectionPlaylist(){let e=this.selection.map(e=>this.elements.find(t=>e===t.uid)).filter(e=>e);if(e.length)return j(e,this.title)}changeMethod(e){this.method!==e&&(this.method&&this.elem.classList.remove("method-"+this.method.id),this.content.scrollTop=0,this.displayed=20,this.method=e,this.method&&this.elem.classList.add("method-"+this.method.id),this.update(),this.onScroll())}clearSelection(){this.selection=[],this.updateSelectionTooltip(),[...this.content.querySelectorAll(".element.selected")].forEach(e=>e.classList.remove("selected"))}updateSelectionTooltip(){let e=this.selection.map(e=>this.elements.find(t=>e===t.uid)).filter(e=>e);this.selection=e.map(e=>e.uid);let t=e.length;this.mapCount.textContent=t+" map"+(1===t?"":"s");let n=B(e.map(e=>({uid:e.uid,pp:e.estimatePP})));this.selectionTooltipPP.textContent="+"+i(Math.max(n-T,0),2)+"pp",this.selectionTooltip.classList[t?"add":"remove"]("show")}onContentClick(e){if((e.ctrlKey||e.metaKey)&&!e.target.matches("a, button")){let t=e.target;for(;t&&!t.classList.contains("element")&&this.content.contains(t);)t=t.parentElement;if(t&&t.classList.contains("element")){let e=+t.getAttribute("data-uid");e&&(this.selection.includes(e)?(this.selection=this.selection.filter(t=>t!==e),t.classList.remove("selected")):(this.selection.push(e),t.classList.add("selected")),this.updateSelectionTooltip())}}}onScroll(){this.content.scrollTop+this.content.clientHeight>this.content.scrollHeight-50&&this.displayMore()}displayMore(){this.displayed>=this.elements.length||(this.displayed+=20,this.refresh())}createMarkup(e){let t=o("element");t.setAttribute("data-uid",e.uid);let a=o("left"),u=o("pic");u.style.backgroundImage="url(https://scoresaber.com/imports/images/songs/"+e.id+".png)",a.appendChild(u);let p=o("name-group"),h=o("name-and-artist");h.title=e.name+" - "+e.artist,h.appendChild(c("name",e.name)),h.appendChild(c("sep")),h.appendChild(c("artist",e.artist)),p.appendChild(h),p.appendChild(o("mapper",e.mapper));let m=e.diff||"Easy",f=n[m]||{},g=o("difficulty-and-score");if(g.appendChild(c("difficulty "+(f.className||m.toLowerCase()),f.display||m)),e.score||0===e.score){let t=c("score-and-rank");if(t.appendChild(c("score",i(e.score,2))),e.at){let n=new Date(e.at);t.appendChild(c("at",s(n),(y=n).getFullYear()+"-"+r(y.getMonth()+1)+"-"+r(y.getDate())+" "+r(y.getHours())+":"+r(y.getMinutes())))}t.appendChild(c("sep")),t.appendChild(c("rank",e.rank.toLocaleString())),g.appendChild(t)}var y;p.appendChild(g),a.appendChild(p),t.appendChild(a);let A=o("middle");A.appendChild(o("pot-title","Potential")),e._potScore=o("pot-score"),A.appendChild(e._potScore);let C=o("pot-pp");e._potPP=c(),C.appendChild(e._potPP),e._potInc=c("increase",null,"Total (weighted) pp change"),C.appendChild(e._potInc),A.appendChild(C),t.appendChild(A);let b=o("right"),v=o("important");v.appendChild(o("star-difficulty",e.stars,"Star difficulty")),void 0!==e.upvotes&&v.appendChild(o("upvotes",e.upvotes,"Upvotes")),void 0!==e.downvotes&&v.appendChild(o("downvotes",e.downvotes,"Downvotes")),b.appendChild(v);let k=o("secondary");e.duration&&k.appendChild(o("duration",function(e){let t=e.duration/e.bpm,n=Math.floor(t);return n+":"+("0"+Math.round(60*(t-n))).slice(-2)}(e),"Duration")),k.appendChild(o("bpm",i(e.bpm,2),"BPM")),b.appendChild(k);let w=o("links");if(e.beatSaverKey){let t=l("button","bsr",null,"Copy !bsr request");t.addEventListener("click",()=>function(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}("!bsr "+e.beatSaverKey)),w.appendChild(t)}e.download&&w.appendChild(d(e.download,"download",null,"Download map","_blank")),e.beatSaverKey&&(w.appendChild(d("beatsaver://"+e.beatSaverKey,"oneclick",null,"OneClick install")),w.appendChild(d("https://beatsaver.com/beatmap/"+e.beatSaverKey,"beatsaver",null,"Open on BeatSaver","_blank"))),w.appendChild(d("https://scoresaber.com/leaderboard/"+e.uid,"leaderboards",null,"ScoreSaber leaderboard","_blank")),b.appendChild(w),t.appendChild(b),e.markup=t}async update(){let e=this.elements,t=e.length;this.titleEl.title=t+" leaderboard"+(1===t?"":"s");let n=this.method,a=Date.now();this.elem.classList.remove("paused"),this.updating&&this.elem.classList.remove("loading"),this.updating=a,n.async&&this.elem.classList.add("loading"),await n.init(e),this.refresh();let i=()=>this.updating!==a;for(let t=0;t<e.length;t++){let a=await n.run(e[t],i);if(n.async){if(i())return;this.refresh()}if("PAUSE_UPDATE"===a){this.elem.classList.add("paused");break}}n.async?this.elem.classList.remove("loading"):this.refresh(),this.updating=!1}defaultSort(e){return e.sort((e,t)=>(t.estimateFull||0)-(e.estimateFull||0)||t.pp-e.pp)}refresh(){for(;this.content.firstChild;)this.content.removeChild(this.content.firstChild);let e=this.method.sort||this.defaultSort;this.elements=e(this.elements),this.elements.slice(0,this.displayed).forEach(e=>{e.markup||this.createMarkup(e),void 0===e.estimateScore&&N(e,0),e._potScore.textContent=i(e.estimateScore,2)+"%",e._potPP.textContent=i(e.estimatePP,2)+"pp",e._potInc.textContent=i(Math.max(e.estimateFull-T,0),2),this.content.appendChild(e.markup)})}}let _=new X(document.querySelector(".list.unplayed"),"Not played",Z),$=new X(document.querySelector(".list.played"),"To improve",Y),ee=document.getElementById("last-update");async function te(e){if(e&&e.preventDefault&&e.preventDefault(),A.classList.contains("loading"))return;let t=C.value.match(/\d{5,}/);if(!t)return void a(A,"invalid");let n=t[0];b.textContent="Getting user infos...",A.classList.add("loading"),C.disabled=!0,P=Date.now();try{let e=await O;E=e.list.reduce((e,t)=>(e[t.uid]=t,e),{}),L=e.timestamp,ee.textContent=new Date(L).toString();let t=await q(n,{useCache:location.search.includes("debug"),onProgress:e=>b.textContent="Getting scores page "+e+"..."});S=t.user,x=t.scores,T=Q(0,0),I(S),H(),F(e,x),window.playerSongs=x,document.body.classList.add("step-results","user-"+n)}catch(e){console.error(e),a(A,"invalid")}C.disabled=!1,A.classList.remove("loading")}A.addEventListener("submit",te),C.addEventListener("paste",()=>setTimeout(te,0)),C.addEventListener("focus",()=>C.select()),document.getElementById("back").addEventListener("click",()=>{C.value="",document.body.classList.remove("step-results")}),document.getElementById("refresh").addEventListener("click",(async function(){if(!S||!S.id)return;document.body.classList.add("refreshing");try{let e=P;P=Date.now();let t=await async function(e,t){let n,a=1,i={};for(let r=!0;r;a++){let s=await f(e,a,2);1===a&&(n=M(e,s));let l=D(s);if(!l)break;let o=Math.min(...l.map(e=>e.at));l=l.map(e=>{let t=E[e.uid];return t&&Object.assign({},t,e)}).filter(e=>e),l.forEach(e=>i[e.uid]=e),o>=t?await p(200):r=!1}return{user:n,scores:i}}(S.id,e);S=t.user,Object.assign(x,t.scores),I(S),T=Q(0,0),H()}catch(e){}let e=h("/ranked",{headers:{"If-Modified-Since":new Date(L).toUTCString()}});try{await e,O=e}catch(e){}F(await O,x),document.body.classList.remove("refreshing")})),document.getElementById("export-curve").addEventListener("click",()=>{let e=document.createElement("canvas");e.width=800,e.height=400,V(e.getContext("2d"),{background:!0,numPoints:500});let t=(S.name||"").replace(/[\W-]+/g,"-").replace(/^-|-$/g,"").toLowerCase();u(e.toDataURL(),t+"-score-curve.png")})}();
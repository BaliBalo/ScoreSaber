const e=location.search.slice(1).split("&").filter((e=>e)).reduce(((e,t)=>{let o=t.split("=");return e[o[0]]=!(o.length>1)||o[1],e}),{});function t(e){let t=e/6e4,o=Math.floor(t);return o+":"+("0"+Math.floor(60*(t-o))).slice(-2)}async function o(e,t){let o="";if(t){o="?"+new URLSearchParams(t).toString()}return await async function(...e){return(await fetch(...e)).json()}("/scoresaber-api"+e+o)}e.debug&&document.body.classList.add("debug"),e.hideSongInfo&&document.body.classList.add("hideSongInfo"),e.hideScoreInfo&&document.body.classList.add("hideScoreInfo");const a={playerImage:document.querySelector(".playerImage"),pp:document.querySelector(".pp"),playerRank:document.querySelector(".playerRank"),playerCountryRank:document.querySelector(".playerCountryRank"),songImage:document.querySelector(".songImage"),songName:document.querySelector(".songName"),songAuthor:document.querySelector(".songAuthor"),songMapper:document.querySelector(".songMapper .value"),songDiff:document.querySelector(".songMapper .difficulty"),misses:document.querySelector(".misses .value"),combo:document.querySelector(".combo .value"),multiplier:document.querySelector(".combo .multiplier"),percentage:document.querySelector(".percentage .value"),score:document.querySelector(".percentage .score"),rank:document.querySelector(".rank .value"),time:document.querySelector(".time .value"),length:document.querySelector(".time .max"),progress:document.querySelector(".timeIndicator")},n="string"==typeof e.u&&e.u.length>5&&e.u;let r=!1;async function l(){if(n&&!r){r=!0;try{let e=await o("/player/"+n+"/full");a.pp.textContent=(e.pp||0).toLocaleString()+"pp",a.playerRank.textContent="#"+(e.rank||0).toLocaleString(),a.playerCountryRank.textContent="#"+(e.countryRank||0).toLocaleString();let t=`https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/${[...e.country.toLowerCase()].map((e=>(e.codePointAt(0)+127365).toString(16))).join("-")}.svg`;a.playerCountryRank.style.backgroundImage='url("'+t+'")',a.playerImage.src=e.profilePicture}catch(e){console.log("err",e)}r=!1}}l();const c=[{at:0,value:0},{at:.6,value:.18223233667439062},{at:.65,value:.5866010012767576},{at:.7,value:.6125565959114954},{at:.75,value:.6451808210101443},{at:.8,value:.6872268862950283},{at:.825,value:.7150465663454271},{at:.85,value:.7462290664143185},{at:.875,value:.7816934560296046},{at:.9,value:.825756123560842},{at:.91,value:.8488375988124467},{at:.92,value:.8728710341448851},{at:.93,value:.9039994071865736},{at:.94,value:.9417362980580238},{at:.95,value:1},{at:.955,value:1.0388633331418984},{at:.96,value:1.0871883573850478},{at:.965,value:1.1552120359501035},{at:.97,value:1.2485807759957321},{at:.9725,value:1.3090333065057616},{at:.975,value:1.3807102743105126},{at:.9775,value:1.4664726399289512},{at:.98,value:1.5702410055532239},{at:.9825,value:1.697536248647543},{at:.985,value:1.8563887693647105},{at:.9875,value:2.058947159052738},{at:.99,value:2.324506282149922},{at:.99125,value:2.4902905794106913},{at:.9925,value:2.685667856592722},{at:.99375,value:2.9190155639254955},{at:.995,value:3.2022017597337955},{at:.99625,value:3.5526145337555373},{at:.9975,value:3.996793606763322},{at:.99825,value:4.325027383589547},{at:.999,value:4.715470646416203},{at:.9995,value:5.019543595874787},{at:1,value:5.367394282890631}];let u={};fetch("/ranked").then((e=>e.ok?e.json():Promise.reject())).then((e=>{u=e.list.reduce(((e,t)=>(t.id&&t.diff&&(e[t.id+"-"+t.diff]=t.pp),e)),{})})).catch((()=>{}));let s=0,i=0,m=0,d=0,p=null,f=function(){let e=null,o=()=>{let n=p||Date.now(),r=Math.max(Math.min(n-d,m),0)||0;a.time.textContent=t(r),a.progress.style.transform="scaleX("+(m?r/m:0)+")",e=requestAnimationFrame(o)};return{start:()=>{e||(e=requestAnimationFrame(o))},stop:()=>{cancelAnimationFrame(e),e=null}}}();function g(e){a.combo.textContent=e.combo.toLocaleString()}function v(e){a.multiplier.textContent="x"+e.multiplier}function y(e){a.misses.textContent=e.missedNotes.toLocaleString()}function S(e){if(i){let t=e.score/s,o=i*function(e){if(!e||e<=0)return 0;let t=c.findIndex((t=>t.at>=e));if(-1===t)return c.at(-1).value;if(!t)return c.at(0).value;let o=c[t-1],a=c[t],n=(e-o.at)/(a.at-o.at);return o.value+n*(a.value-o.value)}(t);a.score.textContent=Math.floor(o).toLocaleString()+"pp"}else a.score.textContent=(e.score||0).toLocaleString()}function h(e){a.percentage.textContent=(e.currentMaxScore?100*e.score/e.currentMaxScore:0).toFixed(2)+"%"}const A={hello:e=>{"Song"===e.game.scene&&A.songStart(e)},songStart:e=>{document.body.classList.add("inSong"),e.performance.combo===e.performance.passedNotes&&document.body.classList.add("fc");let o=e.beatmap;a.songName.textContent=o.songName||"???",a.songAuthor.textContent=o.songAuthorName||"Unknown author",a.songMapper.textContent=o.levelAuthorName||"";const n=o.difficulty||"Unknown",r=n.replace("+","Plus");a.songDiff.textContent=n,a.songDiff.className="difficulty "+r,a.songImage.src="data:image/png;base64,"+(o.songCover||"R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"),s=o.maxScore/e.mod.multiplier,i=o.songHash&&u[o.songHash+"-"+r]||0,console.log(o.songHash+"-"+r,u),m=o.length||0,d=o.start||0,p=o.paused||null,a.length.textContent=t(m),g(e.performance),v(e.performance),y(e.performance),A.scoreChanged(e),f.start()},finished:()=>{f.stop(),setTimeout(l,5e3)},failed:()=>{f.stop()},menu:()=>{document.body.classList.remove("inSong"),f.stop()},obstacleEnter:e=>{document.body.classList.remove("fc"),g(e.performance),v(e.performance)},bombCut:e=>{document.body.classList.remove("fc"),g(e.performance),v(e.performance)},noteCut:e=>{g(e.performance),v(e.performance)},noteMissed:e=>{document.body.classList.remove("fc"),g(e.performance),v(e.performance),y(e.performance),h(e.performance)},pause:e=>{p=e.beatmap.paused},resume:e=>{p=null,d=e.beatmap.start},scoreChanged:e=>{let t=e.performance;a.rank.textContent=t.rank,S(t),h(t)}};!function t(){var o=new WebSocket("ws://"+(e.ip||"localhost")+":"+(e.port||"6557")+"/socket");o.addEventListener("message",(e=>{var t=JSON.parse(e.data),o=A[t.event];"function"==typeof o&&o(t.status,t.time)})),o.addEventListener("close",(()=>{console.log("Socket error - reconnecting in 3s"),setTimeout(t,3e3)}))}();